// Generated by CoffeeScript 1.10.0
(function() {
  var Extractor, InfoJSONCreator, Informer, Validator, _, cache_info_json, config, fs, iiif, image_extraction, info_cache, info_json_path, jp2_binary, log, mkdirp, path, path_for_cache_file, resolve_source_image_path, retrieve_cached_info_json, server_info, tempfile, too_big;

  resolve_source_image_path = require('./resolver').resolve_source_image_path;

  _ = require('lodash');

  tempfile = require('tempfile');

  fs = require('fs');

  mkdirp = require('mkdirp');

  path = require('path');

  retrieve_cached_info_json = require('./caching/retrieve-cached-info-json');

  log = require('./index').log;

  info_cache = require('./index').info_cache;

  config = require('config');

  jp2_binary = config.get('jp2_binary');

  iiif = require('iiif-image');

  Informer = iiif.Informer(jp2_binary);

  Extractor = iiif.Extractor(jp2_binary);

  Validator = iiif.Validator;

  InfoJSONCreator = iiif.InfoJSONCreator;

  path_for_cache_file = require('./caching/path-for-cache-file');

  too_big = require('./helpers').too_big;

  server_info = require('./server-info');

  cache_info_json = require('./caching/cache-info-json');

  info_json_path = require('./info-json-path');


  /*
  This function needs the response object and the incoming URL to parse the URL,
  get information about the image, extract the requested image, and provide a
  response to the client.
   */

  image_extraction = function(req, res, params) {
    var extractor_cb, info_cb, source_image_path, url;
    url = req.path;
    source_image_path = resolve_source_image_path(params.identifier);
    extractor_cb = function(image) {
      var dirname, image_path, image_type;
      image_type = params.format === 'png' ? 'image/png' : 'image/jpeg';
      res.setHeader('Content-Type', image_type);

      /*
      Return the buffer sharp creates which means it does not have to be read
      off the file system.
       */
      log.info({
        res: 'image',
        url: url,
        ip: req.ip
      }, 'response image');
      res.send(image);
      image_path = path_for_cache_file(url);
      dirname = path.dirname(image_path);
      return mkdirp(dirname, function(err, made) {
        if (!err) {
          return fs.writeFile(image_path, image, function(err) {
            if (!err) {
              return log.info({
                cache: 'image',
                op: 'set',
                img: image_path,
                url: url
              }, 'image cached');
            }
          });
        }
      });
    };

    /*
    Once the informer finishes its work it calls this callback sending it the
    information. Now that we have the info it checks to see if the request
    is valid. If it is valid then the extractor then uses the information to
    try to create the image. If the request is not valid then a 400 error is
    returned.
     */
    info_cb = function(info) {
      var extractor, options, validator;
      validator = new Validator(params, info);
      if (validator.valid() && !too_big(params, info)) {
        log.info({
          valid: true,
          test: 'info',
          url: url,
          ip: req.ip
        }, 'valid w/ info');
        options = {
          path: source_image_path,
          params: params,
          info: info
        };
        extractor = new Extractor(options, extractor_cb);
        extractor.extract();
        return fs.stat(info_json_path(req.params.id), function(err, stats) {
          var info_json, info_json_creator;
          if (err) {
            info_json_creator = new InfoJSONCreator(info, server_info(req, req.params.id));
            info_json = info_json_creator.info_json;
            return cache_info_json(req, info_json);
          }
        });
      } else {
        log.info({
          valid: false,
          test: 'info',
          url: url,
          ip: req.ip
        }, 'invalid w/ info');
        log.info({
          res: '400',
          url: url,
          ip: req.ip
        }, '400');
        return res.status(400).send('400');
      }
    };
    return retrieve_cached_info_json(params.identifier, function(info) {
      var informer;
      if (info) {
        return info_cb(info);
      } else {
        informer = new Informer(source_image_path, info_cb);
        return informer.inform();
      }
    });
  };

  module.exports = image_extraction;

}).call(this);
