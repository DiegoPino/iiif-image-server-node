// Generated by CoffeeScript 1.10.0
(function() {
  var Extractor, Informer, Validator, _, config, fs, iiif, image_cache, image_extraction, info_cache, jp2_binary, log, mkdirp, path, path_for_image_cache_file, resolve_image_path, tempfile;

  resolve_image_path = require('./resolver').resolve_image_path;

  _ = require('lodash');

  tempfile = require('tempfile');

  fs = require('fs');

  mkdirp = require('mkdirp');

  path = require('path');

  log = require('./index').log;

  info_cache = require('./index').info_cache;

  image_cache = require('./index').image_cache;

  config = require('config');

  jp2_binary = config.get('jp2_binary');

  iiif = require('iiif-image');

  Informer = iiif.Informer(jp2_binary);

  Extractor = iiif.Extractor(jp2_binary);

  Validator = iiif.Validator;

  path_for_image_cache_file = require('./path-for-image-cache-file');


  /*
  This function needs the response object and the incoming URL to parse the URL,
  get information about the image, extract the requested image, and provide a
  response to the client.
   */

  image_extraction = function(req, res, params) {
    var cache_info, extractor_cb, image_path, info_cb, informer, url;
    url = req.url;
    image_path = resolve_image_path(params.identifier);
    extractor_cb = function(image) {
      var dirname, image_type;
      image_type = params.format === 'png' ? 'image/png' : 'image/jpeg';
      res.setHeader('Content-Type', image_type);

      /*
      Return the buffer sharp creates which means it does not have to be read
      off the file system.
       */
      log.info({
        res: 'image',
        url: url,
        ip: req.ip
      }, 'response image');
      res.send(image);
      if (!image_cache.get(url)) {
        image_path = path_for_image_cache_file(url);
        dirname = path.dirname(image_path);
        return mkdirp(dirname, function(err, made) {
          if (!err) {
            return fs.writeFile(image_path, image, function(err) {
              if (!err) {
                image_cache.set(url, image_path);
                return log.info({
                  cache: 'image',
                  op: 'set',
                  img: image_path,
                  url: url
                }, 'image cached');
              }
            });
          }
        });
      }
    };

    /*
    Once the informer finishes its work it calls this callback sending it the
    information. Now that we have the info it checks to see if the request
    is valid. If it is valid then the extractor then uses the information to
    try to create the image. If the request is not valid then a 400 error is
    returned.
     */
    info_cb = function(info) {
      var extractor, options, validator;
      if (!info_cache.get(params.identifier)) {
        info_cache.set(params.identifier, info);
        log.info({
          cache: 'info',
          op: 'set',
          url: url,
          ip: req.ip
        }, 'info cached');
      }
      validator = new Validator(params, info);
      if (validator.valid()) {
        log.info({
          valid: true,
          test: 'info',
          url: url,
          ip: req.ip
        }, 'valid w/ info');
        options = {
          path: image_path,
          params: params,
          info: info
        };
        extractor = new Extractor(options, extractor_cb);
        return extractor.extract();
      } else {
        log.info({
          valid: false,
          test: 'info',
          url: url,
          ip: req.ip
        }, 'invalid w/ info');
        log.info({
          res: '400',
          url: url,
          ip: req.ip
        }, '400');
        return res.status(400).send('400');
      }
    };
    cache_info = info_cache.get(params.identifier);
    if (cache_info) {
      return info_cb(_.cloneDeep(cache_info));
    } else {
      informer = new Informer(image_path, info_cb);
      return informer.inform();
    }
  };

  module.exports = image_extraction;

}).call(this);
