// Generated by CoffeeScript 1.10.0
(function() {
  var Extractor, Informer, Parser, _, app, express, iiif, path;

  express = require('express');

  app = express();

  _ = require('lodash');

  path = require('path');

  iiif = require('iiif-image');

  Informer = iiif.IIIFImageInformer;

  Extractor = iiif.IIIFImageExtractor;

  Parser = iiif.IIIFImageRequestParser;

  app.get('*', function(req, res) {
    var extractor_cb, image_path, info_cb, informer, params, parser, url;
    url = req.url;
    if (_.includes(url, 'info.json')) {
      return res.send('Still need to implement the proper response to an information request. Most of the data ought to be found in the results of an IIIFImageInformer.');
    } else {
      parser = new Parser(url);
      params = parser.parse();
      console.log(params);
      image_path = path.join(__dirname, "/../images/" + params.identifier + ".jp2");
      console.log(image_path);
      extractor_cb = function(output_image_path) {
        return res.sendFile(output_image_path);
      };
      info_cb = function(info) {
        var extractor, options;
        options = {
          path: image_path,
          params: params,
          info: info
        };
        extractor = new Extractor(options, extractor_cb);
        return extractor.extract();
      };
      informer = new Informer(image_path, info_cb);
      return informer.inform(info_cb);
    }
  });

  app.listen(3000, function() {
    return console.log('Example app listening on port 3000!');
  });

}).call(this);
